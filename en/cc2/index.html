<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV ì˜ë¬¸ ë‹¨ì–´ ê°€ë¦¬ê¸° í€´ì¦ˆ</title>
  <style>
    :root{ --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --good:#34d399; --bad:#f87171; }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}    
    .wrap{max-width:1000px; margin:0 auto; padding:24px}
    .card{background:#0b1220; border:1px solid #1f2937; border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);}    
    h1{font-size:28px; margin:0 0 14px}
    p.sub{margin:0 0 18px; color:var(--muted)}
    .grid{display:grid; gap:16px}
    .g2{grid-template-columns:1fr 1fr}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type="file"]{padding:8px 10px; background:#0b1220; border:1px dashed #334155; border-radius:12px; color:var(--muted)}
    button{appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; background:#1f2937; color:#e5e7eb; border:1px solid #374151}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8); border-color:#1d4ed8}
    button.ghost{background:transparent; border-color:#334155}
    button:disabled{opacity:.6; cursor:not-allowed}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; color:#cbd5e1; font-size:12px}
    .badge{font-weight:700; color:#93c5fd}
    .box{background:#0b1220; border:1px solid #1f2937; border-radius:16px; padding:16px}
    .big{font-size:20px; line-height:1.6}
    .muted{color:var(--muted)}
    .hint{color:#a7f3d0}
    .id{font-variant-numeric:tabular-nums}
    .range{accent-color:#60a5fa}
    .footer{margin-top:22px; color:#94a3b8; font-size:12px}
    .kbd{border:1px solid #334155; background:#0b1220; padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px}
    details{background:#0b1220; border:1px solid #1f2937; border-radius:16px;}
    details>summary{padding:12px 16px; cursor:pointer; list-style:none; font-weight:700}
    details[open]>summary{border-bottom:1px solid #1f2937}
    .content{padding:16px}

    /* ì…ë ¥í˜• ë¹ˆì¹¸/ì±„ì  ìŠ¤íƒ€ì¼ */
    .blank{display:inline-flex; align-items:center; gap:6px; margin:0 2px}
    .blank .first{min-width:0.6em; text-align:center}
    .blank input{background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:8px; padding:2px 6px; font-size:18px; line-height:1.4; width:auto}
    .blank input.good{border-color:var(--good); box-shadow:0 0 0 2px rgba(52,211,153,.15) inset}
    .blank input.bad{border-color:var(--bad); box-shadow:0 0 0 2px rgba(248,113,113,.12) inset}
    .score{font-weight:700}
    @media (max-width:760px){.g2{grid-template-columns:1fr}}
    .hidden{display:none}
    .screen-title{display:flex; align-items:center; justify-content:space-between; gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- ê³µí†µ í—¤ë” -->
      <div class="screen-title">
        <h1>CSV ì˜ë¬¸ ë‹¨ì–´ ê°€ë¦¬ê¸° í€´ì¦ˆ</h1>
        <div class="row">
          <span class="pill">ì´ ë¬¸ì¥ ìˆ˜: <span id="totalCnt">0</span></span>
        </div>
      </div>
      <p class="sub">ë™ì¼ í´ë”ì— <span class="badge">test.csv</span>ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤. ì—†ìœ¼ë©´ CSVë¥¼ ì§ì ‘ ì„ íƒí•˜ì„¸ìš”. í—¤ë”: <span class="kbd">ì¼ë ¨ë²ˆí˜¸</span>, <span class="kbd">ì˜ë¬¸</span>, <span class="kbd">ë²ˆì—­</span> (ë˜ëŠ” <span class="kbd">id</span>, <span class="kbd">english</span>, <span class="kbd">translation</span>).</p>

      <!-- # í™”ë©´ 1: ì‹œì‘ í™”ë©´ -->
      <section id="screen1">
        <div class="grid g2">
          <div class="box">
            <div class="row">
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnDemo" class="ghost">ë°ëª¨ ë¡œë“œ</button>
            </div>
            <div class="row" style="margin-top:10px">
              <label for="level">ê°€ë¦¬ê¸° ë‚œì´ë„: <span id="levelLabel" class="hint">30%</span></label>
              <input id="level" class="range" type="range" min="10" max="80" step="5" value="30"/>
            </div>
            <div class="row" style="margin-top:6px">
              <label><input id="keepFirst" type="checkbox" checked/> ë‹¨ì–´ ì²« ê¸€ìëŠ” ë³´ì´ê¸°</label>
              <label style="margin-left:14px"><input id="minLen" type="number" min="1" max="10" value="3" style="width:64px;"> ê¸€ì ì´ìƒë§Œ ê°€ë¦¬ê¸°</label>
            </div>
          </div>
          <div class="box">
            <div class="row">
              <button id="btnPick" class="primary" disabled>ë¬¸ì œ ë‚´ê¸°</button>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>
        <details>
          <summary>ì‚¬ìš©ë²•</summary>
          <div class="content">
            <ol>
              <li>ë™ì¼ í´ë”ì˜ <b>test.csv</b>ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. ì—†ë‹¤ë©´ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•˜ê±°ë‚˜ <b>ë°ëª¨ ë¡œë“œ</b>ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</li>
              <li>ì„¤ì •ì„ ì¡°ì •í•œ ë’¤ <b>ë¬¸ì œ ë‚´ê¸°</b>ë¥¼ ëˆŒëŸ¬ í€´ì¦ˆ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
            </ol>
            <p class="footer">CSVëŠ” UTF-8 ê¶Œì¥. í—¤ë” ìë™ ì¸ì‹(í•œ/ì˜).</p>
          </div>
        </details>
      </section>

      <!-- # í™”ë©´ 2: í€´ì¦ˆ í™”ë©´ -->
      <section id="screen2" class="hidden">
        <div class="box">
          <div class="row">
            <button id="btnGrade" disabled>ì±„ì </button>
            <button id="btnReveal" disabled>ì •ë‹µ ë³´ê¸°</button>
            <button id="btnNext" class="primary" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
            <button id="btnHome" class="ghost">ì²«í™”ë©´ìœ¼ë¡œ</button>
          </div>
          <div class="row" style="margin-top:6px">
            <span class="pill">ì„ íƒëœ ì¼ë ¨ë²ˆí˜¸: <span id="selId" class="id">â€”</span></span>
            <span class="pill">ì •ë‹µ: <span id="scoreCorrect" class="score">0</span>/<span id="scoreTotal">0</span></span>
          </div>
        </div>

        <div style="height:14px"></div>

        <details open>
          <summary>ë¬¸ì œ ì˜ì—­</summary>
          <div class="content">
            <div>
              <div class="muted">ë²ˆì—­(íŒíŠ¸)</div>
              <div id="ko" class="big">â€”</div>
            </div>
            <div style="height:12px"></div>
            <div>
              <div class="muted">ì˜ë¬¸(ë¹ˆì¹¸ ì±„ìš°ê¸°)</div>
              <div id="enMask" class="big">â€”</div>
            </div>
            <div id="answerWrap" style="display:none; margin-top:12px">
              <div class="muted">ì •ë‹µ(ì›ë¬¸ ì˜ë¬¸)</div>
              <div id="enFull" class="big"></div>
            </div>
          </div>
        </details>
        <div class="footer">ë‹¨ì¼ HTML íŒŒì¼ë¡œ ì˜¤í”„ë¼ì¸ì—ì„œë„ ë™ì‘í•©ë‹ˆë‹¤.</div>
      </section>

    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const state = { rows: [], cols: {id:"ì¼ë ¨ë²ˆí˜¸", en:"ì˜ë¬¸", ko:"ë²ˆì—­"}, current: null };

  // í™”ë©´ ì „í™˜
  const screen1 = $('#screen1');
  const screen2 = $('#screen2');
  function showScreen(which){
    if(which===1){ screen1.classList.remove('hidden'); screen2.classList.add('hidden'); }
    else { screen2.classList.remove('hidden'); screen1.classList.add('hidden'); }
  }

  // ìš”ì†Œ ì°¸ì¡°
  const csvInput = $('#csvFile');
  const btnDemo = $('#btnDemo');
  const btnPick = $('#btnPick');
  const btnReveal = $('#btnReveal');
  const btnNext = $('#btnNext');
  const btnGrade = $('#btnGrade');
  const btnHome = $('#btnHome');
  const ko = $('#ko');
  const enMask = $('#enMask');
  const enFull = $('#enFull');
  const level = $('#level');
  const levelLabel = $('#levelLabel');
  const keepFirst = $('#keepFirst');
  const minLen = $('#minLen');
  const selId = $('#selId');
  const totalCnt = $('#totalCnt');
  const answerWrap = $('#answerWrap');
  const scoreCorrect = $('#scoreCorrect');
  const scoreTotal = $('#scoreTotal');

  level.addEventListener('input', () => levelLabel.textContent = level.value + '%');

  // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
  csvInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    handleCSV(text);
  });

  // ì—”í„°í‚¤ë¡œ ì±„ì : ë§ˆì§€ë§‰ ì…ë ¥ì¹¸ì´ë©´ gradeCurrent(), ì•„ë‹ˆë©´ ë‹¤ìŒì¹¸ í¬ì»¤ìŠ¤
document.querySelector('#enMask').addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  const t = e.target;
  if(!(t instanceof HTMLInputElement)) return;
  if(!t.matches('input[data-ans]')) return;

  e.preventDefault(); // í¼ ì œì¶œ/ê°œí–‰ ë°©ì§€
  const inputs = Array.from(document.querySelectorAll('input[data-ans]'));
  const idx = inputs.indexOf(t);
  if(idx === inputs.length - 1){
    document.activeElement.blur();
    gradeCurrent();                 // ğŸ”¹ë§ˆì§€ë§‰ ì¹¸ì´ë©´ ì±„ì  ì‹¤í–‰
  }else if(idx > -1){
    inputs[idx + 1].focus();        // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ì´ë™
  }
});

  // ë™ì¼ í´ë”ì˜ test.csv ìë™ ë¡œë“œ ì‹œë„
  window.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const res = await fetch('./test.csv', {cache:'no-store'});
      if(res.ok){
        const txt = await res.text();
        if(/,/.test(txt)){
          handleCSV(txt);
          toast('./test.csv ìë™ ë¡œë“œë¨');
        }
      }
    }catch(err){ /* íŒŒì¼ ì—†ìœ¼ë©´ ë¬´ì‹œ */ }
  });

  // ë°ëª¨ ë¡œë“œ
  btnDemo.addEventListener('click', ()=>{
    const demo = `ì¼ë ¨ë²ˆí˜¸,ì˜ë¬¸,ë²ˆì—­
1,"Learning a new language takes time and practice.","ìƒˆ ì–¸ì–´ë¥¼ ë°°ìš°ë ¤ë©´ ì‹œê°„ê³¼ ì—°ìŠµì´ í•„ìš”í•´ìš”."
2,"Consistency beats intensity when building habits.","ìŠµê´€ì„ ë§Œë“¤ ë•ŒëŠ” ê°•ë„ë³´ë‹¤ ê¾¸ì¤€í•¨ì´ ë” ì¤‘ìš”í•´ìš”."
3,"Failure is not the opposite of success; it is part of success.","ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ë°˜ëŒ€ê°€ ì•„ë‹ˆë¼ ì„±ê³µì˜ ì¼ë¶€ì˜ˆìš”."
4,"Small daily improvements lead to stunning long-term results.","ì‘ì€ ì¼ìƒì˜ ê°œì„ ì´ ë†€ë¼ìš´ ì¥ê¸°ì  ì„±ê³¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤."`;
    handleCSV(demo);
  });

  // í™”ë©´1: ë¬¸ì œ ë‚´ê¸° â†’ í€´ì¦ˆ í™”ë©´ ì „í™˜
  btnPick.addEventListener('click', ()=>{
    if(!state.rows.length){ toast('ë¨¼ì € CSVë¥¼ ë¡œë“œí•˜ì„¸ìš”'); return; }
    pickQuestion();
    showScreen(2);
  });

  // í™”ë©´2: ë‹¤ìŒ/ì •ë‹µ/ì±„ì /ì²«í™”ë©´ìœ¼ë¡œ
  btnNext.addEventListener('click', pickQuestion);
  btnReveal.addEventListener('click', showAnswer);
  btnGrade.addEventListener('click', gradeCurrent);
  btnHome.addEventListener('click', ()=>{ showScreen(1); });

  function showAnswer(){
    if(!state.current) return;
    enFull.textContent = state.current[state.cols.en] || '';
    answerWrap.style.display = 'block';
  }

  // CSV ë¡œë“œ ì²˜ë¦¬
  function handleCSV(text){
    try{
      const rows = parseCSV(text);
      if(!rows.length) throw new Error('ë¹ˆ CSV');

      // í—¤ë” ë§¤í•‘ (í•œêµ­ì–´ ê¸°ë³¸, ì˜ë¬¸ ëŒ€ì•ˆ í—ˆìš©)
      const header = Object.keys(rows[0]);
      const norm = h => h.replace(/\s+/g,'').toLowerCase();
      const byNorm = Object.fromEntries(header.map(h=>[norm(h), h]));
      const idKey = byNorm['ì¼ë ¨ë²ˆí˜¸'] || byNorm['id'] || header[0];
      const enKey = byNorm['ì˜ë¬¸'] || byNorm['english'] || header[1];
      const koKey = byNorm['ë²ˆì—­'] || byNorm['translation'] || header[2];

      state.cols = { id: idKey, en: enKey, ko: koKey };
      state.rows = rows.filter(r=> (r[enKey]??'').toString().trim() );

      totalCnt.textContent = state.rows.length;
      btnPick.disabled = !state.rows.length;

      // í™”ë©´2 ë²„íŠ¼ ì´ˆê¸°í™”
      btnNext.disabled = !state.rows.length;
      btnReveal.disabled = true;
      btnGrade.disabled = true;

      // ë¬¸ì œ ì˜ì—­ ì´ˆê¸°í™”
      ko.textContent = 'â€”';
      enMask.textContent = 'â€”';
      enFull.textContent = '';
      answerWrap.style.display = 'none';
      selId.textContent = 'â€”';
      scoreCorrect.textContent = '0';
      scoreTotal.textContent = '0';

      toast(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${state.rows.length}ê±´`);
    }catch(err){
      alert('CSV íŒŒì‹± ì˜¤ë¥˜: ' + err.message);
    }
  }

  // ë¬¸ì œ ìƒì„±
  function pickQuestion(){
    if(!state.rows.length) return;
    const idx = Math.floor(Math.random() * state.rows.length);
    const row = state.rows[idx];
    state.current = row;

    const idv = row[state.cols.id] ?? (idx+1);
    const en = (row[state.cols.en]||'').toString();
    const koText = (row[state.cols.ko]||'').toString();

    const maskedInfo = maskEnglish(en, { 
      ratio: Number(level.value)/100, 
      keepFirst: keepFirst.checked, 
      minLen: Math.max(1, Number(minLen.value)||1)
    });

    ko.textContent = koText;
    enMask.innerHTML = maskedInfo.html; // ì…ë ¥ í¬í•¨ëœ HTML
    enFull.textContent = '';
    answerWrap.style.display = 'none';
    selId.textContent = idv;

    // ìŠ¤ì½”ì–´ ì´ˆê¸°í™”
    scoreCorrect.textContent = '0';
    scoreTotal.textContent = String(maskedInfo.totalBlanks);

    btnReveal.disabled = false;
    btnGrade.disabled = maskedInfo.totalBlanks === 0;
    btnNext.disabled = false;

    // ì²« ë²ˆì§¸ ë¹ˆì¹¸ í¬ì»¤ìŠ¤
    const firstBlank = document.querySelector('input[data-ans]');
    if(firstBlank) firstBlank.focus();
  }

  // ì±„ì 
  function gradeCurrent(){
    const inputs = Array.from(document.querySelectorAll('input[data-ans]'));
    if(inputs.length===0){ toast('ì±„ì í•  ë¹ˆì¹¸ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
    let correct = 0;
    for(const inp of inputs){
      const ans = inp.getAttribute('data-ans') || '';
      const keep = inp.getAttribute('data-keepfirst')==='1';
      const user = (inp.value||'').trim();
      const fullUser = keep ? ((ans[0]||'') + user) : user;
      if(fullUser.localeCompare(ans, undefined, {sensitivity:'accent'})===0){
        inp.classList.remove('bad');
        inp.classList.add('good');
        correct++;
      }else{
        inp.classList.remove('good');
        inp.classList.add('bad');
      }
    }
    scoreCorrect.textContent = String(correct);
    scoreTotal.textContent = String(inputs.length);
  }

  // ë§ˆìŠ¤í‚¹ ë¡œì§
  function maskEnglish(sentence, opt){
    const {ratio, keepFirst, minLen} = opt;
    // í† í°ì„ ë‹¨ì–´/ê³µë°±/êµ¬ë‘ì ìœ¼ë¡œ ë¶„ë¦¬
    const tokens = sentence.match(/\w+|\s+|[^\w\s]/g) || [sentence];
    const wordsIdx = tokens
      .map((t,i)=>(/^[A-Za-z][A-Za-z\d']*$/i.test(t) && t.length>=minLen ? i : -1))
      .filter(i=>i>=0);

    const hideCount = Math.max(1, Math.floor(wordsIdx.length * ratio));
    shuffle(wordsIdx);
    const hideSet = new Set(wordsIdx.slice(0, hideCount));

    let blanks = 0;
    const out = tokens.map((t,i)=>{
      if(!hideSet.has(i)) return escapeHTML(t);
      blanks++;
      const first = keepFirst ? t[0] : '';
      const expectLen = keepFirst ? Math.max(1, t.length-1) : t.length;
      return `<span class="blank"><span class="first">${escapeHTML(first)}</span><input type="text" data-ans="${escapeHTML(t)}" data-keepfirst="${keepFirst?1:0}" size="${Math.min(24, Math.max(2, expectLen))}" autocomplete="off" spellcheck="false"/></span>`;
    });

    return { html: out.join(''), totalBlanks: blanks };
  }

  // ìœ í‹¸
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
  function escapeHTML(s){ return s.replace(/[&<>\"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]) ); }

  // CSV íŒŒì„œ
  function parseCSV(text){
    const lines = text.replace(/\uFEFF/, '').split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length===0) return [];
    const header = splitCSVLine(lines[0]);
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = splitCSVLine(lines[i]);
      const obj = {};
      for(let j=0;j<header.length;j++) obj[header[j]] = cols[j] ?? '';
      rows.push(obj);
    }
    return rows;
  }

  function splitCSVLine(line){
    const out = [];
    let cur = '';
    let inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(inQ){
        if(ch=='"'){
          if(line[i+1]=='"'){ cur+='"'; i++; } else { inQ=false; }
        } else cur+=ch;
      } else {
        if(ch=='"') inQ = true;
        else if(ch==','){ out.push(cur); cur=''; }
        else cur+=ch;
      }
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }

  // í† ìŠ¤íŠ¸
  function toast(msg){
    const el=document.createElement('div');
    el.textContent=msg;
    el.style.position='fixed'; el.style.left='50%'; el.style.top='18px'; el.style.transform='translateX(-50%)';
    el.style.background='#0b1220'; el.style.border='1px solid #1f2937'; el.style.padding='8px 12px'; el.style.borderRadius='10px'; el.style.color='#cbd5e1'; el.style.boxShadow='0 10px 20px rgba(0,0,0,.35)';
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 1600);
  }
})();
</script>
</body>
</html>
